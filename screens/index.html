<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoneyMentorX</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Inter font from Tailwind defaults */
  body {
    font-family: 'Inter', sans-serif;
  }
  /* Custom scrollbar style for chat log */
  #chatLog::-webkit-scrollbar {
    width: 6px;
  }
  #chatLog::-webkit-scrollbar-thumb {
    background-color: #A5B4FC; /* Indigo-300 */
    border-radius: 3px;
  }
</style>
</head>
<body class="bg-gray-100 h-screen font-sans">

<div class="flex flex-col md:flex-row h-screen p-4 sm:p-6 gap-6">

  <!-- Left Panel: Form Card -->
  <div class="md:w-1/2 bg-white shadow-xl rounded-2xl p-6 overflow-y-auto">
    <h1 class="text-3xl font-extrabold text-blue-700 text-center mb-6 border-b pb-3">🤖 MoneyMentorX <span class="text-gray-400 text-xl font-normal">Advisor</span></h1>
    <form id="questionnaire" class="space-y-8">
<!-- 🧠 Section 1 – About You -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">🧠 Section 1 – About You</h2>
  <div class="space-y-4">
    <div>
      <label for="age_range" class="block font-medium text-gray-700">Age Range</label>
      <select id="age_range" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>18–24 years</option>
        <option>25–34 years</option>
        <option>35–54 years</option>
        <option>55+ years</option>
      </select>
    </div>

    <div>
      <label for="investment_goal" class="block font-medium text-gray-700">Investment Goal</label>
      <select id="investment_goal" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Building long-term wealth (Growth)</option>
        <option>Saving for a home or big purchase (Medium)</option>
        <option>Family / children’s future (Medium-Long)</option>
        <option>Building an emergency fund (Preservation)</option>
        <option>Other (Neutral)</option>
      </select>
    </div>
  </div>
</section>

<!-- 💸 Section 2 – Financial Situation -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">💸 Section 2 – Financial Situation</h2>
  <div class="space-y-4">
    <div>
      <label for="income_stability" class="block font-medium text-gray-700">Income Stability</label>
      <select id="income_stability" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Unstable or varies month-to-month</option>
        <option>Mostly stable (some variability)</option>
        <option>Very stable and predictable</option>
      </select>
    </div>

    <div>
      <label for="liabilities_ratio" class="block font-medium text-gray-700">Liabilities & Expenses (as % of income)</label>
      <select id="liabilities_ratio" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>More than 40%</option>
        <option>20–40%</option>
        <option>Less than 20%</option>
      </select>
    </div>

    <div>
      <label for="emergency_fund" class="block font-medium text-gray-700">Emergency Fund Coverage</label>
      <select id="emergency_fund" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>None or minimal</option>
        <option>1–3 months covered</option>
        <option>3–6 months or more covered</option>
      </select>
    </div>

    <div>
      <label for="monthly_savings" class="block font-medium text-gray-700">Monthly Savings or Investments</label>
      <select id="monthly_savings" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>&lt; 5% of income</option>
        <option>5–15% of income</option>
        <option>&gt; 15% of income</option>
      </select>
    </div>

    <div>
      <label for="initial_investment" class="block font-medium text-gray-700">Initial Investment Amount</label>
      <select id="initial_investment" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>&lt; €1,000 (Minimal)</option>
        <option>€1,000 – €10,000 (Moderate)</option>
        <option>&gt; €10,000 (Significant)</option>
      </select>
    </div>
  </div>
</section>

<!-- 📊 Section 3 – Behavior & Attitude -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">📊 Section 3 – Behavior & Attitude</h2>
  <div class="space-y-4">
    <div>
      <label for="reaction_to_loss" class="block font-medium text-gray-700">Market Loss Scenario (If your investment dropped 20%)</label>
      <select id="reaction_to_loss" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Sell immediately to prevent more losses</option>
        <option>Do nothing and wait for recovery</option>
        <option>Invest more to buy at lower prices</option>
      </select>
    </div>

    <div>
      <label for="risk_preference" class="block font-medium text-gray-700">Risk vs Reward Preference (When presented with two options)</label>
      <select id="risk_preference" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Always the safer one (lower risk, lower reward)</option>
        <option>Maybe accept some risk (balanced approach)</option>
        <option>Take the riskier one (higher risk, higher potential reward)</option>
      </select>
    </div>

    <div>
      <label for="volatility_feeling" class="block font-medium text-gray-700">Market Volatility Feelings</label>
      <select id="volatility_feeling" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Nervous – I prefer stability</option>
        <option>Neutral – I expect ups and downs</option>
        <option>Excited – I see opportunities</option>
      </select>
    </div>

    <div>
      <label for="investing_experience" class="block font-medium text-gray-700">Investment Experience</label>
      <select id="investing_experience" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Beginner (no experience)</option>
        <option>Some experience (read a few books/articles)</option>
        <option>Experienced / Active investor</option>
      </select>
    </div>
  </div>
</section>

<!-- 🏦 Section 4 – Time Horizon & Approach -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">🏦 Section 4 – Time Horizon & Approach</h2>
  <div class="space-y-4">
    <div>
      <label for="investment_horizon" class="block font-medium text-gray-700">Investment Horizon (when do you need the money)</label>
      <select id="investment_horizon" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>&lt; 3 years (Short-term)</option>
        <option>3–7 years (Medium-term)</option>
        <option>7+ years (Long-term)</option>
      </select>
    </div>

    <div>
      <label for="investment_approach" class="block font-medium text-gray-700">Investment Approach</label>
      <select id="investment_approach" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>One-time investment (Lump sum)</option>
        <option>Monthly contributions (DCA)</option>
        <option>Combination of both</option>
      </select>
    </div>
  </div>
</section>

<!-- 💻 Section 5 – Tech Savviness -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">💻 Section 5 – Tech Savviness</h2>
  <div class="space-y-4">
    <div>
      <label for="tech_usage" class="block font-medium text-gray-700">How often do you use digital banking or investing apps?</label>
      <select id="tech_usage" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Rarely</option>
        <option>Sometimes</option>
        <option>Regularly</option>
      </select>
    </div>

    <div>
      <label for="trust_ai" class="block font-medium text-gray-700">Would you trust an AI-driven advisor to manage your investments?</label>
      <select id="trust_ai" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>No</option>
        <option>Yes</option>
        <option>Maybe</option>
      </select>
    </div>
  </div>
</section>

<!-- 🌱 Section 6 – Preferences -->
<section>
  <h2 class="text-xl font-semibold text-blue-600 mb-2">🌱 Section 6 – Preferences (Customization)</h2>
  <div class="space-y-4">
    <div>
      <label for="esg_preference" class="block font-medium text-gray-700">Sustainability Preference (ESG)</label>
      <select id="esg_preference" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Yes</option>
        <option>No</option>
        <option>No preference</option>
      </select>
    </div>

    <div>
      <label for="regional_focus" class="block font-medium text-gray-700">Regional Focus</label>
      <select id="regional_focus" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-blue-500 focus:border-blue-500">
        <option>Global</option>
        <option>Europe (EU)</option>
        <option>U.S. (US)</option>
        <option>No preference</option>
      </select>
    </div>
  </div>
</section>
      <button type="submit" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 w-full mt-8 shadow-lg transition duration-200 transform hover:scale-[1.01]">
        💡 Assess My Profile
      </button>
    </form>
  </div>

  <!-- Right Panel -->
  <div class="md:w-1/2 flex flex-col gap-6">
    <div id="results" class="bg-white shadow-xl rounded-2xl p-4 flex-1 overflow-y-auto">
      <h3 class="text-2xl font-bold text-blue-700 mb-3 border-b pb-2">📊 Your Investment Profile</h3>
      <div id="resultText" class="text-gray-700 mb-4">
        <p class="text-gray-500">Fill out the questionnaire and click 'Assess My Profile' to view your results and recommended portfolio.</p>
      </div>
      <div id="etfCharts" class="mt-4 space-y-4"></div>
    </div>

    <div id="chatbot" class="bg-gradient-to-br from-indigo-50 to-white shadow-xl rounded-2xl p-5 flex flex-col h-72 border border-indigo-100">
      <h4 class="text-2xl font-bold mb-3 text-indigo-700 tracking-tight">
        💬 Chat with <span class="text-indigo-500">MoneyMentorX</span>
      </h4>
      <div id="chatLog" class="flex-1 overflow-y-auto mb-3 space-y-3 text-gray-800 font-sans text-sm leading-relaxed">
        <div class="text-left bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-xl max-w-[80%] font-sans text-sm shadow-md">
          Hello! I'm MoneyMentorX. Complete the questionnaire and I'll analyze your profile and allocation.
        </div>
      </div>
      <div class="flex gap-2">
        <input id="chatInput" type="text" placeholder="Ask me anything..."
               class="flex-1 border border-indigo-200 rounded-xl p-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-400 placeholder-gray-400">
        <button id="chatSend" class="bg-indigo-600 text-white rounded-xl px-5 py-2.5 font-medium hover:bg-indigo-700 active:bg-indigo-800 transition-all duration-200 shadow-md">
          Send
        </button>
      </div>
    </div>
  </div>

</div>

<script>
const API = window.location.origin;

// Helper to try to parse response body (JSON or text)
async function parseResponseBody(res) {
  try {
    return await res.json();
  } catch (e) {
    try {
      return await res.text();
    } catch (e2) {
      return '<unreadable response body>';
    }
  }
}

// Global handlers to surface runtime errors on screen
window.addEventListener('error', (ev) => {
  try {
    const msg = `Uncaught error: ${ev.message} (${ev.filename}:${ev.lineno}:${ev.colno})`;
    console.error(msg, ev.error);
    showError(msg + '\nSee console for stack.');
  } catch (e) { console.error('Error showing global error:', e); }
});

window.addEventListener('unhandledrejection', (ev) => {
  try {
    const reason = ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason);
    const msg = `Unhandled Promise Rejection: ${reason}`;
    console.error(msg, ev.reason);
    showError(msg + '\nSee console for details.');
  } catch (e) { console.error('Error showing unhandled rejection:', e); }
});

// Show loading message
function showLoading(msg) {
  document.getElementById("resultText").innerHTML = `
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md">
      <p class="font-bold">Loading...</p>
      <p>${msg}</p>
    </div>
  `;
}

// Show error message
function showError(msg) {
  document.getElementById("resultText").innerHTML = `
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
      <p class="font-bold">Error</p>
      <p>${msg}</p>
    </div>
  `;
}

// Form submission
document.getElementById("questionnaire").onsubmit = async function(e) {
  e.preventDefault();
  const resultsDiv = document.getElementById("results");
  const etfChartsDiv = document.getElementById("etfCharts");
  etfChartsDiv.innerHTML = "";
  resultsDiv.classList.remove("hidden");

  try {
    showLoading("Analyzing your profile and calculating risk score...");

    const getVal = id => document.getElementById(id).value;

    // --- FIX: Collect ALL 17 new fields explicitly and send them to the backend ---
    const data = {
        age_range: getVal("age_range"),
        investment_goal: getVal("investment_goal"),
        income_stability: getVal("income_stability"),
        liabilities_ratio: getVal("liabilities_ratio"),
        emergency_fund: getVal("emergency_fund"),
        monthly_savings: getVal("monthly_savings"),
        initial_investment: getVal("initial_investment"),
        reaction_to_loss: getVal("reaction_to_loss"),
        risk_preference: getVal("risk_preference"),
        volatility_feeling: getVal("volatility_feeling"),
        investing_experience: getVal("investing_experience"),
        investment_horizon: getVal("investment_horizon"),
        investment_approach: getVal("investment_approach"),
        tech_usage: getVal("tech_usage"),
        trust_ai: getVal("trust_ai"),
        esg_preference: getVal("esg_preference"),
        regional_focus: getVal("regional_focus"),
        sectors_to_avoid: [] // Placeholder for future feature
    };
    
    // Log the actual data being sent to help with backend debugging
    console.log("Data sent to /assess:", data);

    // Fetch risk assessment
    const res = await fetch(API + "/assess", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const body = await parseResponseBody(res);
      const msg = `Assessment request failed: ${res.status} ${res.statusText} - ${JSON.stringify(body)}`;
      console.error(msg);
      showError(msg);
      return;
    }
    const assess = await res.json();
    console.log("DEBUG: assess response:", assess);

    // Render a small 5-year projections chart with easy-to-understand labels
  function renderProjectionsChart(summary) {
    try {
      const proj = summary && summary.projections;
      if (!proj || !proj.years) return;

      // Set chart heading
      const headingDiv = document.getElementById('projectionHeading');
      if (headingDiv) headingDiv.innerText = "📈 5-Year Investment Projections";

      const ctx = document.getElementById('projectionChart');
      if (!ctx) return;

      const years = proj.years.map(y => `Year ${y}`);
      const median = proj.median.map(x => (Number(x) - 1) * 100);
      const p10 = proj.p10.map(x => (Number(x) - 1) * 100);
      const p90 = proj.p90.map(x => (Number(x) - 1) * 100);

      // Destroy existing chart instance if present
      if (ctx._chartInstance) {
        try { ctx._chartInstance.destroy(); } catch(e){}
      }

      ctx._chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            { label: 'Most Likely Outcome', data: median, borderColor: '#2563EB', backgroundColor: 'rgba(37,99,235,0.08)', fill: false },
            { label: 'Lower Range (Conservative)', data: p10, borderColor: '#DC2626', borderDash: [6,4], fill: false, pointStyle: 'dash' },
            { label: 'Upper Range (Optimistic)', data: p90, borderColor: '#16A34A', borderDash: [6,4], fill: false, pointStyle: 'dash' }
          ]
        },
        options: { 
          responsive: true, 
          plugins: { 
            legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rect' } } 
          }, 
          scales: { 
            y: { 
              ticks: { callback: v => v.toFixed(1) + '%' },
              title: { display: true, text: 'Projected Growth (%)' }
            },
            x: {
              title: { display: true, text: 'Years' }
            }
          } 
        }
      });
    } catch (e) {
      console.error('Projection chart error', e);
    }
  }

    // Render assessment summary once
    const renderAssessSummary = (assessObj) => {
      // Prefer the backend-provided summary if present
      const summary = assessObj.summary || {
        score: assessObj.score,
        risk_bucket: assessObj.risk_bucket,
        target_volatility_text: (assessObj.target_volatility_pct_range ? `${assessObj.target_volatility_pct_range[0]}–${assessObj.target_volatility_pct_range[1]}%` : 'N/A'),
        typical_allocation_text: (assessObj.typical_allocation_hint ? `${assessObj.typical_allocation_hint.equity_pct}% Equity / ${assessObj.typical_allocation_hint.bond_pct}% Fixed Income` : 'N/A'),
        risk_profile: assessObj.risk_bucket // Fallback
      };

      document.getElementById("resultText").innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-lg space-y-6">
    
    <!-- Investment Profile Summary -->
    <div class="grid grid-cols-2 gap-6 bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-100">
      <div>
        <p class="font-semibold text-gray-600">Risk Level</p>
        <p class="text-xl font-bold text-blue-700">${summary.risk_bucket}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-600">Risk Profile</p>
        <p class="text-xl font-bold text-blue-700">${summary.risk_profile}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-600">Target Volatility</p>
        <p class="text-gray-800">${summary.target_volatility_text}</p>
      </div>
      <div>
        <p class="font-semibold text-gray-600">Recommended Split</p>
        <p class="text-gray-800">${summary.typical_allocation_text}</p>
      </div>
    </div>
    <!-- 5-Year Projection Section -->
    <div class="bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-100">
      <div id="projectionHeading" class="text-lg font-semibold text-blue-600 mb-2"></div>
      <canvas id="projectionChart" height="200"></canvas>
    </div>

  </div>
      `;
    };


    // Decide where to get ETF/portfolio data from: prefer payload from /assess if present
    let etfData = null;
    if (assess.etf_portfolio) {
      console.log('Using etf_portfolio returned in /assess payload');
      // Attach backend summary (if any) to the portfolio object so UI renders canonical values
      etfData = Object.assign({}, assess.etf_portfolio, { summary: assess.summary });
    } else {
      // Fetch ETF recommendations from /recommend endpoint
      const etfRes = await fetch(API + "/recommend/" + assess.risk_bucket);
      if (!etfRes.ok) {
        const body = await parseResponseBody(etfRes);
        const msg = `ETF recommendation failed: ${etfRes.status} ${etfRes.statusText} - ${JSON.stringify(body)}`;
        console.error(msg);
        showError(msg);
        return;
      }
      etfData = await etfRes.json();
      console.log("DEBUG: etf response:", etfData);
    }

  // Use backend summary or computed summary to render the user-facing summary
    let summaryToUse = null;
    if (etfData && etfData.summary) {
      summaryToUse = etfData.summary;
    } else {
      // Try to build summary from allocation (etfData may be a portfolio object)
      const alloc = (etfData && etfData.allocation) ? etfData.allocation : (assess.typical_allocation_hint ? assess.typical_allocation_hint : null);
      if (alloc && typeof alloc === 'object') {
        const bondTickers = new Set(['AGG','BND','BNDX','TLT']);
        const converted = {};
        Object.entries(alloc).forEach(([k,v]) => converted[k] = Number(v));
        const equity_pct = Object.entries(converted).reduce((sum, [k,v]) => sum + (bondTickers.has(k) ? 0 : v), 0);
        const bond_pct = Math.max(0, 1 - equity_pct);
        const tvVal = (etfData && etfData.target_volatility) ? Number(etfData.target_volatility) : (assess.target_volatility ? Number(assess.target_volatility) : null);
        const target_vol_text = (tvVal && tvVal > 0 && tvVal <= 0.05) ? '0–5%' : (tvVal ? `${(tvVal*100).toFixed(1)}%` : 'N/A');
        summaryToUse = {
          score: assess.score,
          risk_bucket: assess.risk_bucket,
          target_volatility_text: target_vol_text,
          typical_allocation_text: `${Math.round(equity_pct*100)}% Equity / ${Math.round(bond_pct*100)}% Bond`,
          allocation: converted,
          shortlisted_etfs: Object.keys(converted),
          risk_profile: assess.risk_bucket // Ensure risk_profile is set
        };
      } else {
        summaryToUse = assess.summary || { score: assess.score, risk_bucket: assess.risk_bucket, target_volatility_text: 'N/A', typical_allocation_text: 'N/A', risk_profile: assess.risk_bucket };
      }
    }

    renderAssessSummary(Object.assign({}, assess, { summary: summaryToUse }));
    // Render projections chart if available
    renderProjectionsChart(summaryToUse);

    // Display ETF charts
    etfChartsDiv.innerHTML = "";
    if (etfData.etfs) {
      // ... (existing ETF rendering logic remains the same)
      Object.entries(etfData.etfs).forEach(([ticker, info], idx) => {
        try {
          if (!info?.history) return;
          const card = document.createElement("div");
          card.className = "bg-white rounded-xl p-4 shadow mb-4 border border-gray-100";

          const header = document.createElement("div");
          header.className = "flex justify-between items-center mb-2";
          header.innerHTML = `<h5 class="text-lg font-bold text-blue-600">${ticker}</h5>
            <div class="text-sm"><span class="text-green-600 font-medium">Return: ${(info.ann_return*100).toFixed(1)}%</span>
            <span class="mx-2 text-gray-300">|</span><span class="text-blue-600 font-medium">Vol: ${(info.volatility*100).toFixed(1)}%</span></div>`;
          const canvas = document.createElement("canvas");
          canvas.id = `chart${ticker}_${idx}`; // Use unique ID
          canvas.height = 120;

          card.appendChild(header);
          card.appendChild(canvas);
          etfChartsDiv.appendChild(card);

          const dates = Object.keys(info.history).sort();
          const prices = dates.map(d => info.history[d]);
          new Chart(canvas, {
            type: "line",
            data: { labels: dates, datasets: [{label: ticker, data: prices, borderColor:"#3B82F6", tension:0.25, borderWidth:2, pointRadius: 0}] },
            options: { 
                responsive:true, 
                plugins:{legend:{display:false}},
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
          });
        } catch (chartErr) {
          console.error('Chart render error for', ticker, chartErr);
          const errNode = document.createElement('div');
          errNode.className = 'text-sm text-red-600 p-2 border border-red-200 rounded-lg';
          errNode.textContent = `Chart error for ${ticker}: ${chartErr.message || chartErr}`;
          etfChartsDiv.appendChild(errNode);
        }
      });
    } else if (etfData.allocation) {
      // Backend returned a single portfolio object (allocation + metrics).
      console.log('Rendering portfolio response:', etfData);

      const portfolio = etfData;
      // Build portfolio summary
      const summaryCard = document.createElement('div');
      summaryCard.className = 'bg-white p-4 rounded-xl shadow mb-4 border border-gray-100';
      const formatPercent = v => (Number(v) * 100).toFixed(1) + '%';
      summaryCard.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-3">
          <div>
            <p class="font-semibold text-gray-600">Portfolio Name</p>
            <p class="text-lg font-bold text-indigo-700">${portfolio.name || 'Optimized Portfolio'}</p>
            <p class="text-sm text-gray-500 mt-1">${portfolio.description || 'A risk-adjusted mix for your profile.'}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-600">Key Metrics</p>
            <p>Annual Return: <span class="text-green-600 font-medium">${portfolio.target_return ? formatPercent(portfolio.target_return) : 'N/A'}</span></p>
            <p>Annual Volatility: <span class="text-blue-600 font-medium">${portfolio.target_volatility ? formatPercent(portfolio.target_volatility) : 'N/A'}</span></p>
            <p>Sharpe Ratio: <span class="text-gray-800 font-medium">${portfolio.sharpe_ratio != null ? Number(portfolio.sharpe_ratio).toFixed(2) : 'N/A'}</span></p>
          </div>
        </div>
      `;
      etfChartsDiv.appendChild(summaryCard);
  // If the backend provided projections on the portfolio, render them
  const portfolioSummary = portfolio.summary || summaryToUse || null;
  if (portfolioSummary) renderProjectionsChart(portfolioSummary);

      // Allocation table
      const alloc = portfolio.allocation || {};
      const allocEntries = Object.entries(alloc).filter(([, pct]) => Number(pct) > 0).sort((a, b) => b[1] - a[1]); // Sort by size
      const table = document.createElement('table');
      table.className = 'w-full text-sm mb-4 bg-gray-50 rounded-lg p-2';
      table.innerHTML = `
        <thead><tr class="border-b"><th class="text-left font-bold py-2 px-1 text-gray-600">ETF/Category</th><th class="text-right font-bold py-2 px-1 text-gray-600">Allocation</th></tr></thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      allocEntries.forEach(([ticker, pct]) => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-100 last:border-b-0';
        tr.innerHTML = `<td class="py-1 px-1 text-gray-800">${ticker}</td><td class="py-1 px-1 text-right font-medium text-indigo-600">${(Number(pct)*100).toFixed(2)}%</td>`;
        tbody.appendChild(tr);
      });
      etfChartsDiv.appendChild(table);

      // Doughnut chart for allocation
      const chartCard = document.createElement('div');
      chartCard.className = 'bg-white p-4 rounded-xl shadow mb-4 border border-gray-100';
      const canvas = document.createElement('canvas');
      canvas.id = 'allocationChart';
      canvas.height = 160;
      chartCard.appendChild(canvas);
      etfChartsDiv.appendChild(chartCard);

      // Prepare chart data
      const labels = allocEntries.map(e => e[0]);
      const values = allocEntries.map(e => Number(e[1]));
      // Use a consistent, appealing color palette
      const colors = ['#2563EB', '#FBBF24', '#10B981', '#EF4444', '#6366F1', '#EC4899', '#34D399', '#F97316'];

      try {
        new Chart(canvas, {
          type: 'doughnut',
          data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
          options: { 
            responsive: true, 
            plugins: { 
              legend: { position: 'right' } ,
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed !== null) {
                      label += (context.parsed * 100).toFixed(2) + '%';
                    }
                    return label;
                  }
                }
              }
            } 
          }
        });
      } catch (e) {
        console.error('Allocation chart error', e);
        const errNode = document.createElement('div');
        errNode.className = 'text-sm text-red-600';
        errNode.textContent = 'Allocation chart failed to render.';
        etfChartsDiv.appendChild(errNode);
      }
    }

    // --- FIX: Automatically send the assessment data to the chat for AI explanation ---
    // Note: The `explainProfileAutomatically` function is missing from the provided JS, 
    // but the original intent was likely just to populate the chat.
    // We will just log the data here for now.
    console.log("Assessment completed. You can now use the chatbot with personalized context.");

  } catch(err) {
    console.error(err);
    showError(err.message || "Error fetching results.");
  }
};

// Chatbot setup
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");
const chatLog = document.getElementById("chatLog");

// Helper: send message to chat API
async function sendChat(message) {
  if (!message) return;

  // User message
  const userMsg = document.createElement("div");
  userMsg.className = "text-right bg-indigo-100 text-indigo-900 p-3 rounded-xl max-w-[80%] ml-auto font-sans text-sm shadow-sm";
  userMsg.innerText = message;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;
  
  // Show a loading indicator
  const loadingMsg = document.createElement("div");
  loadingMsg.id = 'loadingIndicator';
  loadingMsg.className = "text-left bg-gray-200 text-gray-700 p-3 rounded-xl max-w-[80%] font-sans text-sm shadow-sm animate-pulse";
  loadingMsg.innerText = "MoneyMentorX is typing...";
  chatLog.appendChild(loadingMsg);
  chatLog.scrollTop = chatLog.scrollHeight;

  try {
    // Call your backend endpoint that proxies the LLM API
    const res = await fetch(API + "/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message})
    });
    
    // Remove loading indicator
    document.getElementById('loadingIndicator')?.remove();

    if (!res.ok) {
        const errorBody = await parseResponseBody(res);
        const errorMsg = `Chat API failed: ${res.status} ${res.statusText} - ${JSON.stringify(errorBody)}`;
        console.error(errorMsg);
        
        const errorBotMsg = document.createElement("div");
        errorBotMsg.className = "text-left bg-red-500 text-white p-3 rounded-xl max-w-[80%] font-sans text-sm shadow-md";
        errorBotMsg.innerHTML = "Sorry, the chat service encountered an error.";
        chatLog.appendChild(errorBotMsg);
        chatLog.scrollTop = chatLog.scrollHeight;
        return;
    }

    const data = await res.json();

    // Bot message
    const botMsg = document.createElement("div");
    botMsg.className = "text-left bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-xl max-w-[80%] font-sans text-sm shadow-md";
    botMsg.innerHTML = data.reply.replace(/\n/g, '<br>'); // Handle newlines
    chatLog.appendChild(botMsg);
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch (err) {
      console.error('Chat function error:', err);
      document.getElementById('loadingIndicator')?.remove();
      const errorBotMsg = document.createElement("div");
      errorBotMsg.className = "text-left bg-red-500 text-white p-3 rounded-xl max-w-[80%] font-sans text-sm shadow-md";
      errorBotMsg.innerHTML = "A network error occurred while trying to chat.";
      chatLog.appendChild(errorBotMsg);
      chatLog.scrollTop = chatLog.scrollHeight;
  }
}

// Event listeners for chat
chatSend.onclick = () => {
  sendChat(chatInput.value);
  chatInput.value = '';
};

chatInput.onkeydown = (e) => {
  if (e.key === 'Enter') {
    sendChat(chatInput.value);
    chatInput.value = '';
  }
};
</script>
</body>
</html>
