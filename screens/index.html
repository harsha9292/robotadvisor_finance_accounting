<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MoneyMentorX</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 h-screen font-sans">

<div class="flex flex-col md:flex-row h-screen p-6 gap-6">

  <!-- Left Panel: Form Card -->
  <div class="md:w-1/2 bg-white shadow-lg rounded-2xl p-6 overflow-y-auto">
    <h1 class="text-3xl font-bold text-blue-700 text-center mb-6">ü§ñ MoneyMentorX</h1>
    <form id="questionnaire" class="space-y-6">

      <!-- Basic Info -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Basic Info</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="number" id="age" placeholder="Age" class="border rounded-lg p-2 w-full" required>
          <input type="number" id="income" placeholder="Income (‚Ç¨)" class="border rounded-lg p-2 w-full" required>
        </div>
      </section>

      <!-- Investment Objectives -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Investment Objectives</h2>
        <label>1Ô∏è‚É£ Primary Goal</label>
        <select id="primary_goal" class="border rounded-lg p-2 w-full">
          <option value="a">Saving for home (3‚Äì7 years)</option>
          <option value="b">Long-term wealth (15+ years)</option>
          <option value="c">Children‚Äôs future (10‚Äì15 years)</option>
          <option value="d">Emergency fund (1‚Äì3 years)</option>
          <option value="e">Other</option>
        </select>

        <label>2Ô∏è‚É£ Access Time</label>
        <select id="access_time" class="border rounded-lg p-2 w-full">
          <option value="a">Within 3 years</option>
          <option value="b">3‚Äì7 years</option>
          <option value="c">7‚Äì15 years</option>
          <option value="d">More than 15 years</option>
        </select>
      </section>

      <!-- Financial Situation -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Financial Situation</h2>
        <label>3Ô∏è‚É£ Income Stability</label>
        <select id="income_stability" class="border rounded-lg p-2 w-full">
          <option value="a">Very stable</option>
          <option value="b">Somewhat stable</option>
          <option value="c">Unstable</option>
        </select>

        <label>4Ô∏è‚É£ Emergency Fund</label>
        <select id="emergency_fund" class="border rounded-lg p-2 w-full">
          <option value="a">Yes</option>
          <option value="b">Partially</option>
          <option value="c">No</option>
        </select>
      </section>

      <!-- Investment Approach -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Investment Approach</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label>5Ô∏è‚É£ Investment Plan</label>
            <select id="investment_plan" class="border rounded-lg p-2 w-full">
              <option value="a">One-time investment</option>
              <option value="b">Monthly contributions</option>
              <option value="c">Combination</option>
              <option value="d">Not sure</option>
            </select>
          </div>
          <div>
            <label>6Ô∏è‚É£ Initial Investment</label>
            <select id="initial_investment" class="border rounded-lg p-2 w-full">
              <option value="a">Less than ‚Ç¨1,000</option>
              <option value="b">‚Ç¨1,000‚Äì‚Ç¨10,000</option>
              <option value="c">Over ‚Ç¨10,000</option>
            </select>
          </div>
        </div>
      </section>

      <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 w-full mt-4">
        üí° Assess My Profile
      </button>
    </form>
  </div>

<!-- Right Panel: Results + Chat -->
<div class="md:w-1/2 flex flex-col gap-6">

  <!-- Results Card -->
  <div id="results" class="bg-white shadow-lg rounded-2xl p-4 flex-1 overflow-y-auto">
    <h3 class="text-2xl font-semibold text-blue-700 mb-3">üìä Your Investment Profile</h3>
    <div id="resultText" class="text-gray-700 mb-4">
      <!-- Empty initially -->
    </div>
    <div id="etfCharts" class="mt-4 space-y-4"></div>
  </div>

  <!-- Chatbot Card -->
  <div id="chatbot" class="bg-white shadow-lg rounded-2xl p-4 flex flex-col h-64">
    <h4 class="text-xl font-semibold mb-2 text-blue-600">üí¨ Chat with MoneyMentorX</h4>
    <div id="chatLog" class="flex-1 overflow-y-auto mb-2 space-y-2 text-gray-700"></div>
    <div class="flex gap-2">
      <input type="text" id="chatInput" class="flex-1 border rounded-lg p-2" placeholder="Ask me anything...">
      <button id="chatSend" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700">Send</button>
    </div>
  </div>
</div>

</div>

<script>
const API = window.location.origin;

// Form Submission
document.getElementById("questionnaire").onsubmit = async function(e){
  e.preventDefault();
  const getVal = id => document.getElementById(id).value;

  const data = {
    age: parseFloat(getVal("age")),
    income: parseFloat(getVal("income")),
    investment_goal:"retirement",
    primary_goal:getVal("primary_goal"),
    access_time:getVal("access_time"),
    income_stability:getVal("income_stability"),
    emergency_fund:getVal("emergency_fund"),
    investment_plan:getVal("investment_plan"),
    initial_investment:getVal("initial_investment"),
    reaction_to_loss:"b",
    investing_experience:"a",
    geographical_focus:"a",
    esg_preference:"c",
    sectors_to_avoid:[]
  };

  document.getElementById("results").classList.add("hidden");

  try {
    const res = await fetch(API+"/assess",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
    const assess = await res.json();
    const etfRes = await fetch(API+"/recommend/"+assess.risk_bucket);
    const etfs = await etfRes.json();

    const results=document.getElementById("results");
    results.classList.remove("hidden");
    document.getElementById("resultText").innerHTML=`
      <p><strong>Risk Bucket:</strong> ${assess.risk_bucket}</p>
      <p><strong>Score:</strong> ${assess.score}</p>
      <p><strong>Target Volatility:</strong> ${assess.target_volatility_pct_range[0]}‚Äì${assess.target_volatility_pct_range[1]}%</p>
      <p><strong>Typical Allocation:</strong> ${assess.typical_allocation_hint.equity_pct}% Equity / ${assess.typical_allocation_hint.bond_pct}% Bond</p>
      <hr class="my-2">
      <h4 class="text-lg font-semibold mb-2">ETF Recommendations (Cluster ${etfs.cluster})</h4>
    `;

    const etfContainer=document.getElementById("etfCharts");
    etfContainer.innerHTML="";
    Object.entries(etfs.etfs).forEach(([ticker,info],idx)=>{
      if(!info.history) return;
      const card=document.createElement("div");
      card.className="border rounded-lg p-2 shadow-sm";
      card.innerHTML=`
        <h5 class="font-semibold text-blue-600">${ticker}</h5>
        <p>Return: ${(info.ann_return*100).toFixed(2)}%, Volatility: ${(info.volatility*100).toFixed(2)}%</p>
        <canvas id="chart${idx}" height="100"></canvas>
      `;
      etfContainer.appendChild(card);
      const dates=Object.keys(info.history).sort();
      const prices=dates.map(d=>info.history[d]).filter(v=>v!=null);
      new Chart(document.getElementById(`chart${idx}`),{
        type:"line",
        data:{labels:dates,datasets:[{label:ticker,data:prices,borderColor:"#3B82F6",tension:0.25,borderWidth:2}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
      });
    });

  } catch(err){console.error(err); alert("Error fetching results.");}
};

// Chatbot
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const chatLog=document.getElementById("chatLog");

chatSend.onclick=async ()=>{
  const msg=chatInput.value.trim();
  if(!msg) return;
  chatInput.value="";
  const userMsg=document.createElement("div");
  userMsg.className="text-right bg-gray-200 p-2 rounded";
  userMsg.innerText=msg;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop=chatLog.scrollHeight;

  try{
    const res=await fetch(API+"/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
    const data=await res.json();
    const botMsg=document.createElement("div");
    botMsg.className="text-left bg-blue-600 text-white p-2 rounded";
    botMsg.innerText=data.reply;
    chatLog.appendChild(botMsg);
    chatLog.scrollTop=chatLog.scrollHeight;
  }catch(err){console.error(err);}
};

chatInput.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();chatSend.click();}});
</script>
</body>
</html>
