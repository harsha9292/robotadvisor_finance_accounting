<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MoneyMentorX</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 h-screen font-sans">

<div class="flex flex-col md:flex-row h-screen p-6 gap-6">

  <!-- Left Panel: Form Card -->
  <div class="md:w-1/2 bg-white shadow-lg rounded-2xl p-6 overflow-y-auto">
    <h1 class="text-3xl font-bold text-blue-700 text-center mb-6">ü§ñ MoneyMentorX</h1>
    <form id="questionnaire" class="space-y-6">

      <!-- Basic Info -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Basic Info</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="number" id="age" placeholder="Age" class="border rounded-lg p-2 w-full" required>
          <input type="number" id="income" placeholder="Income (‚Ç¨)" class="border rounded-lg p-2 w-full" required>
        </div>
      </section>

      <!-- Investment Objectives -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Investment Objectives</h2>
        <label>1Ô∏è‚É£ Primary Goal</label>
        <select id="primary_goal" class="border rounded-lg p-2 w-full">
          <option value="a">Saving for home (3‚Äì7 years)</option>
          <option value="b">Long-term wealth (15+ years)</option>
          <option value="c">Children‚Äôs future (10‚Äì15 years)</option>
          <option value="d">Emergency fund (1‚Äì3 years)</option>
          <option value="e">Other</option>
        </select>

        <label>2Ô∏è‚É£ Access Time</label>
        <select id="access_time" class="border rounded-lg p-2 w-full">
          <option value="a">Within 3 years</option>
          <option value="b">3‚Äì7 years</option>
          <option value="c">7‚Äì15 years</option>
          <option value="d">More than 15 years</option>
        </select>
      </section>

      <!-- Financial Situation -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Financial Situation</h2>
        <label>3Ô∏è‚É£ Income Stability</label>
        <select id="income_stability" class="border rounded-lg p-2 w-full">
          <option value="a">Very stable</option>
          <option value="b">Somewhat stable</option>
          <option value="c">Unstable</option>
        </select>

        <label>4Ô∏è‚É£ Emergency Fund</label>
        <select id="emergency_fund" class="border rounded-lg p-2 w-full">
          <option value="a">Yes</option>
          <option value="b">Partially</option>
          <option value="c">No</option>
        </select>
      </section>

      <!-- Investment Approach -->
      <section class="space-y-2">
        <h2 class="text-xl font-semibold text-blue-600">Investment Approach</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label>5Ô∏è‚É£ Investment Plan</label>
            <select id="investment_plan" class="border rounded-lg p-2 w-full">
              <option value="a">One-time investment</option>
              <option value="b">Monthly contributions</option>
              <option value="c">Combination</option>
              <option value="d">Not sure</option>
            </select>
          </div>
          <div>
            <label>6Ô∏è‚É£ Initial Investment</label>
            <select id="initial_investment" class="border rounded-lg p-2 w-full">
              <option value="a">Less than ‚Ç¨1,000</option>
              <option value="b">‚Ç¨1,000‚Äì‚Ç¨10,000</option>
              <option value="c">Over ‚Ç¨10,000</option>
            </select>
          </div>
        </div>
      </section>

      <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 w-full mt-4">
        üí° Assess My Profile
      </button>
    </form>
  </div>

<!-- Right Panel: Results + Chat -->
<div class="md:w-1/2 flex flex-col gap-6">

  <!-- Results Card -->
  <div id="results" class="bg-white shadow-lg rounded-2xl p-4 flex-1 overflow-y-auto">
    <h3 class="text-2xl font-semibold text-blue-700 mb-3">üìä Your Investment Profile</h3>
      <!-- 5-Year Projection Section -->
    <div class="bg-white shadow-lg rounded-2xl p-4 mb-4">
      <div id="projectionHeading" class="text-lg font-semibold text-blue-600 mb-2"></div>
      <canvas id="projectionChart" height="200"></canvas>
    </div>
    <div id="resultText" class="text-gray-700 mb-4">
      <!-- Empty initially -->
    </div>


    <div id="etfCharts" class="mt-4 space-y-4"></div>
  </div>

  <!-- Chatbot Card -->
  <div id="chatbot" class="bg-white shadow-lg rounded-2xl p-4 flex flex-col h-64">
    <h4 class="text-xl font-semibold mb-2 text-blue-600">üí¨ Chat with MoneyMentorX</h4>
    <div id="chatLog" class="flex-1 overflow-y-auto mb-2 space-y-2 text-gray-700"></div>
    <div class="flex gap-2">
      <input type="text" id="chatInput" class="flex-1 border rounded-lg p-2" placeholder="Ask me anything...">
      <button id="chatSend" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700">Send</button>
    </div>
  </div>
</div>

</div>

<script>
const API = window.location.origin;

// Helper to try to parse response body (JSON or text)
async function parseResponseBody(res) {
  try {
    return await res.json();
  } catch (e) {
    try {
      return await res.text();
    } catch (e2) {
      return '<unreadable response body>';
    }
  }
}

// Global handlers to surface runtime errors on screen
window.addEventListener('error', (ev) => {
  try {
    const msg = `Uncaught error: ${ev.message} (${ev.filename}:${ev.lineno}:${ev.colno})`;
    console.error(msg, ev.error);
    showError(msg + '\nSee console for stack.');
  } catch (e) { console.error('Error showing global error:', e); }
});

window.addEventListener('unhandledrejection', (ev) => {
  try {
    const reason = ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason);
    const msg = `Unhandled Promise Rejection: ${reason}`;
    console.error(msg, ev.reason);
    showError(msg + '\nSee console for details.');
  } catch (e) { console.error('Error showing unhandled rejection:', e); }
});

// Show loading message
function showLoading(msg) {
  document.getElementById("resultText").innerHTML = `
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4">
      <p class="font-bold">Loading...</p>
      <p>${msg}</p>
    </div>
  `;
}

// Show error message
function showError(msg) {
  document.getElementById("resultText").innerHTML = `
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
      <p class="font-bold">Error</p>
      <p>${msg}</p>
    </div>
  `;
}

// Form submission
document.getElementById("questionnaire").onsubmit = async function(e) {
  e.preventDefault();
  const resultsDiv = document.getElementById("results");
  const etfChartsDiv = document.getElementById("etfCharts");
  etfChartsDiv.innerHTML = "";
  resultsDiv.classList.remove("hidden");

  try {
    showLoading("Analyzing your profile...");

    const getVal = id => document.getElementById(id).value;

    const data = {
      age: parseFloat(getVal("age")),
      income: parseFloat(getVal("income")),
      investment_goal: "retirement",
      primary_goal: getVal("primary_goal"),
      access_time: getVal("access_time"),
      income_stability: getVal("income_stability"),
      emergency_fund: getVal("emergency_fund"),
      investment_plan: getVal("investment_plan"),
      initial_investment: getVal("initial_investment"),
      reaction_to_loss: "hold",
      investing_experience: "moderate",
      geographical_focus: "global",
      esg_preference: "balanced",
      sectors_to_avoid: []
    };

    // Fetch risk assessment
    const res = await fetch(API + "/assess", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const body = await parseResponseBody(res);
      const msg = `Assessment request failed: ${res.status} ${res.statusText} - ${JSON.stringify(body)}`;
      console.error(msg);
      showError(msg);
      return;
    }
    const assess = await res.json();
    console.log("DEBUG: assess response:", assess);

    // Render assessment summary once
    const renderAssessSummary = (assessObj) => {
      // Prefer the backend-provided summary if present
      const summary = assessObj.summary || {
        score: assessObj.score,
        risk_bucket: assessObj.risk_bucket,
        target_volatility_text: (assessObj.target_volatility_pct_range ? `${assessObj.target_volatility_pct_range[0]}‚Äì${assessObj.target_volatility_pct_range[1]}%` : 'N/A'),
        typical_allocation_text: (assessObj.typical_allocation_hint ? `${assessObj.typical_allocation_hint.equity_pct}% Equity / ${assessObj.typical_allocation_hint.bond_pct}% Fixed Income` : 'N/A')
      };

      if (summary.typical_allocation_text && summary.typical_allocation_text.includes('20%')) {
        console.warn('renderAssessSummary: using legacy 20%/80% placeholder');
      }
      document.getElementById("resultText").innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><p class="font-semibold text-gray-600">Risk Level</p><p class="text-xl">${summary.risk_bucket}</p></div>
            <div><p class="font-semibold text-gray-600">Score</p><p class="text-xl">${summary.score}</p></div>
            <div><p class="font-semibold text-gray-600">Target Volatility</p><p>${summary.target_volatility_text}</p></div>
            <div><p class="font-semibold text-gray-600">Recommended Split</p><p>${summary.typical_allocation_text}</p></div>
          </div>
        </div>
      `;
      // Insert a small projection chart placeholder under the summary
      const projContainer = document.createElement('div');
      projContainer.className = 'mt-3';
      projContainer.innerHTML = `<canvas id="projectionChart" height="120"></canvas>`;
      document.getElementById('resultText').appendChild(projContainer);
    };

    // Render a small 5-year projections chart with easy-to-understand labels
  function renderProjectionsChart(summary) {
    try {
      const proj = summary && summary.projections;
      if (!proj || !proj.years) return;

      // Set chart heading
      const headingDiv = document.getElementById('projectionHeading');
      if (headingDiv) headingDiv.innerText = "üìà 5-Year Investment Projections";

      const ctx = document.getElementById('projectionChart');
      if (!ctx) return;

      const years = proj.years.map(y => `Year ${y}`);
      const median = proj.median.map(x => (Number(x) - 1) * 100);
      const p10 = proj.p10.map(x => (Number(x) - 1) * 100);
      const p90 = proj.p90.map(x => (Number(x) - 1) * 100);

      // Destroy existing chart instance if present
      if (ctx._chartInstance) {
        try { ctx._chartInstance.destroy(); } catch(e){}
      }

      ctx._chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            { label: 'Most Likely Outcome', data: median, borderColor: '#2563EB', backgroundColor: 'rgba(37,99,235,0.08)', fill: false },
            { label: 'Lower Range (Conservative)', data: p10, borderColor: '#DC2626', borderDash: [6,4], fill: false },
            { label: 'Upper Range (Optimistic)', data: p90, borderColor: '#16A34A', borderDash: [6,4], fill: false }
          ]
        },
        options: { 
          responsive: true, 
          plugins: { 
            legend: { position: 'bottom' } 
          }, 
          scales: { 
            y: { 
              ticks: { callback: v => v.toFixed(1) + '%' },
              title: { display: true, text: 'Projected Growth (%)' }
            },
            x: {
              title: { display: true, text: 'Years' }
            }
          } 
        }
      });
    } catch (e) {
      console.error('Projection chart error', e);
    }
  }

  // Do not render the initial assess summary here. Wait until we have the portfolio/etfData
  // so the UI shows the backend's canonical summary (etfData.summary) or a computed summary.

    // Decide where to get ETF/portfolio data from: prefer payload from /assess if present
    let etfData = null;
    if (assess.etf_portfolio) {
      console.log('Using etf_portfolio returned in /assess payload');
      // Attach backend summary (if any) to the portfolio object so UI renders canonical values
      etfData = Object.assign({}, assess.etf_portfolio, { summary: assess.summary });
    } else {
      // Fetch ETF recommendations from /recommend endpoint
      const etfRes = await fetch(API + "/recommend/" + assess.risk_bucket);
      if (!etfRes.ok) {
        const body = await parseResponseBody(etfRes);
        const msg = `ETF recommendation failed: ${etfRes.status} ${etfRes.statusText} - ${JSON.stringify(body)}`;
        console.error(msg);
        showError(msg);
        return;
      }
      etfData = await etfRes.json();
      console.log("DEBUG: etf response:", etfData);
    }

  // (debug JSON removed) Use backend summary or computed summary to render the user-facing summary

    // If backend provided a summary with the portfolio, re-render the assessment summary.
    // Otherwise, compute a summary from the returned allocation so the UI matches backend allocation.
    let summaryToUse = null;
    if (etfData && etfData.summary) {
      summaryToUse = etfData.summary;
    } else {
      // Try to build summary from allocation (etfData may be a portfolio object)
      const alloc = (etfData && etfData.allocation) ? etfData.allocation : (assess.typical_allocation_hint ? assess.typical_allocation_hint : null);
      if (alloc && typeof alloc === 'object') {
        const bondTickers = new Set(['AGG','BND','BNDX','TLT']);
        const converted = {};
        Object.entries(alloc).forEach(([k,v]) => converted[k] = Number(v));
        const equity_pct = Object.entries(converted).reduce((sum, [k,v]) => sum + (bondTickers.has(k) ? 0 : v), 0);
        const bond_pct = Math.max(0, 1 - equity_pct);
        const tvVal = (etfData && etfData.target_volatility) ? Number(etfData.target_volatility) : (assess.target_volatility ? Number(assess.target_volatility) : null);
        const target_vol_text = (tvVal && tvVal > 0 && tvVal <= 0.05) ? '0‚Äì5%' : (tvVal ? `${(tvVal*100).toFixed(1)}%` : 'N/A');
        summaryToUse = {
          score: assess.score,
          risk_bucket: assess.risk_bucket,
          target_volatility_text: target_vol_text,
          typical_allocation_text: `${Math.round(equity_pct*100)}% Equity / ${Math.round(bond_pct*100)}% Bond`,
          allocation: converted,
          shortlisted_etfs: Object.keys(converted)
        };
      } else {
        summaryToUse = assess.summary || { score: assess.score, risk_bucket: assess.risk_bucket, target_volatility_text: 'N/A', typical_allocation_text: 'N/A' };
      }
    }

  // Log objects to help trace mismatches between backend and UI
  console.debug('ASSESS payload:', assess);
  console.debug('ETF data payload:', etfData);
  console.debug('Summary used for rendering:', summaryToUse);
  renderAssessSummary(Object.assign({}, assess, { summary: summaryToUse }));
  // Render projections chart if available
  renderProjectionsChart(summaryToUse);

    // Display ETF charts
    etfChartsDiv.innerHTML = "";
    if (etfData.etfs) {
      Object.entries(etfData.etfs).forEach(([ticker, info], idx) => {
        try {
          if (!info?.history) return;
          const card = document.createElement("div");
          card.className = "bg-white rounded-lg p-4 shadow-lg mb-4";

          const header = document.createElement("div");
          header.className = "flex justify-between items-center mb-2";
          header.innerHTML = `<h5 class="text-lg font-bold text-blue-600">${ticker}</h5>
            <div class="text-sm"><span class="text-green-600">Return: ${(info.ann_return*100).toFixed(1)}%</span>
            <span class="mx-2">|</span><span class="text-blue-600">Vol: ${(info.volatility*100).toFixed(1)}%</span></div>`;
          const canvas = document.createElement("canvas");
          canvas.id = `chart${idx}`;
          canvas.height = 120;

          card.appendChild(header);
          card.appendChild(canvas);
          etfChartsDiv.appendChild(card);

          const dates = Object.keys(info.history).sort();
          const prices = dates.map(d => info.history[d]);
          new Chart(canvas, {
            type: "line",
            data: { labels: dates, datasets: [{label: ticker, data: prices, borderColor:"#3B82F6", tension:0.25, borderWidth:2}] },
            options: { responsive:true, plugins:{legend:{display:false}} }
          });
        } catch (chartErr) {
          console.error('Chart render error for', ticker, chartErr);
          const errNode = document.createElement('div');
          errNode.className = 'text-sm text-red-600';
          errNode.textContent = `Chart error for ${ticker}: ${chartErr.message || chartErr}`;
          etfChartsDiv.appendChild(errNode);
        }
      });
    } else {
      // Backend returned a single portfolio object (allocation + metrics).
      console.log('Rendering portfolio response:', etfData);

      const portfolio = etfData;
      // Build portfolio summary
      const summary = document.createElement('div');
      summary.className = 'bg-white p-4 rounded-lg shadow mb-4';
      const formatPercent = v => (Number(v) * 100).toFixed(1) + '%';
      summary.innerHTML = `
        <div class="grid grid-cols-2 gap-4 mb-3">
          <div>
            <p class="font-semibold text-gray-600">Portfolio</p>
            <p class="text-lg font-bold">${portfolio.name || 'Portfolio'}</p>
            <p class="text-sm text-gray-500 mt-1">${portfolio.description || ''}</p>
          </div>
          <div>
            <p class="font-semibold text-gray-600">Metrics</p>
            <p>Target Return: <span class="text-green-600">${formatPercent(portfolio.target_return)}</span></p>
            <p>Target Volatility: <span class="text-blue-600">${formatPercent(portfolio.target_volatility)}</span></p>
            <p>Sharpe Ratio: <span class="text-gray-800">${portfolio.sharpe_ratio != null ? Number(portfolio.sharpe_ratio).toFixed(2) : 'N/A'}</span></p>
          </div>
        </div>
      `;
      etfChartsDiv.appendChild(summary);
  // If the backend provided projections on the portfolio, render them
  const portfolioSummary = portfolio.summary || summaryToUse || null;
  if (portfolioSummary) renderProjectionsChart(portfolioSummary);

      // Allocation table
      const alloc = portfolio.allocation || {};
      const allocEntries = Object.entries(alloc);
      const table = document.createElement('table');
      table.className = 'w-full text-sm mb-4';
      table.innerHTML = `
        <thead><tr><th class="text-left">Ticker</th><th class="text-right">Allocation</th></tr></thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      allocEntries.forEach(([ticker, pct]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-1">${ticker}</td><td class="py-1 text-right">${(Number(pct)*100).toFixed(2)}%</td>`;
        tbody.appendChild(tr);
      });
      etfChartsDiv.appendChild(table);

      // Doughnut chart for allocation
      const chartCard = document.createElement('div');
      chartCard.className = 'bg-white p-4 rounded-lg shadow mb-4';
      const canvas = document.createElement('canvas');
      canvas.id = 'allocationChart';
      canvas.height = 160;
      chartCard.appendChild(canvas);
      etfChartsDiv.appendChild(chartCard);

      // Prepare chart data
      const labels = allocEntries.map(e => e[0]);
      const values = allocEntries.map(e => Number(e[1]));
      const colors = labels.map((_, i) => `hsl(${(i * 360 / Math.max(1, labels.length))}, 70%, 50%)`);

      try {
        new Chart(canvas, {
          type: 'doughnut',
          data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      } catch (e) {
        console.error('Allocation chart error', e);
        const errNode = document.createElement('div');
        errNode.className = 'text-sm text-red-600';
        errNode.textContent = 'Allocation chart failed to render.';
        etfChartsDiv.appendChild(errNode);
      }
    }

  } catch(err) {
    console.error(err);
    showError(err.message || "Error fetching results.");
  }
};

// Chatbot setup
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");
const chatLog = document.getElementById("chatLog");

// Helper: send message to OpenAI API
async function sendChat(message) {
  if (!message) return;
  const userMsg = document.createElement("div");
  userMsg.className = "text-right bg-gray-200 p-2 rounded";
  userMsg.innerText = message;
  chatLog.appendChild(userMsg);
  chatLog.scrollTop = chatLog.scrollHeight;

  try {
    // Call your backend endpoint that proxies OpenAI API
    const res = await fetch(API + "/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message})
    });
    const data = await res.json();

    const botMsg = document.createElement("div");
    botMsg.className = "text-left bg-blue-600 text-white p-2 rounded";
    botMsg.innerText = data.reply;
    chatLog.appendChild(botMsg);
    chatLog.scrollTop = chatLog.scrollHeight;
  } catch(err) {
    console.error(err);
    const botMsg = document.createElement("div");
    botMsg.className = "text-left bg-red-200 text-red-700 p-2 rounded";
    botMsg.innerText = "Failed to get explanation from AI.";
    chatLog.appendChild(botMsg);
  }
}

// Manual input
chatSend.onclick = async () => {
  const msg = chatInput.value.trim();
  if (!msg) return;
  chatInput.value = "";
  await sendChat(msg);
};

chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter") { e.preventDefault(); chatSend.click(); }
});

// --- AUTO EXPLANATION ---
// Call this function after assessment is complete
function explainProfileAutomatically(assessmentResult) {
  // Prepare a simple message for ChatGPT
  const prompt = `
Explain this investment profile simply for a user: 
${JSON.stringify(assessmentResult, null, 2)}
Include risk level, allocation, and portfolio suggestions in simple language.
`;

  sendChat(prompt);
}

</script>
</body>
</html>
